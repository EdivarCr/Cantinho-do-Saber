datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// ------------------------------------------------------
// ENUMS (Valores em Português para o Banco de Dados)
// ------------------------------------------------------

enum SchoolGrade {
  PRIMEIRO_ANO
  SEGUNDO_ANO
  TERCEIRO_ANO
  QUARTO_ANO
  QUINTO_ANO
  SEXTO_ANO
  SETIMO_ANO
  OITAVO_ANO
  NONO_ANO
}

enum Shift {
  MATUTINO
  VESPERTINO
}

enum AccessLevel {
  ADMIN
  PROFESSOR
  COMUM
}

enum AttendanceStatus {
  PRESENTE
  AUSENTE
  JUSTIFICADO
}

enum Kinship {
  PAI_MAE
  AVOS
  TIOS
  IRMAOS
  OUTRO
}

// ------------------------------------------------------
// USUÁRIOS E PERFIS
// ------------------------------------------------------

model User {
  id       String @id @unique @default(ulid())
  name     String
  email    String @unique
  password String

  profile   Profile @relation(fields: [profileId], references: [id])
  profileId String  @unique

  createdAt DateTime
  deletedAt DateTime?
}

model Profile {
  id          String      @id @unique @default(ulid())
  accessLevel AccessLevel

  user User?
}

// ------------------------------------------------------
// PEDAGÓGICO: PROFESSOR, TURMA, AULA
// ------------------------------------------------------

model Teacher {
  id        String  @id @unique @default(ulid())
  name      String
  taxId     String  @unique // CPF
  phone     String  @unique
  pixKey    String
  expertise String?

  // Quais séries este professor está habilitado? (Array de Enums)
  qualifiedGrades SchoolGrade[]

  email     String   @unique
  startDate DateTime
  status    String   @default("ATIVO") // String simples ou poderia ser Enum se preferir

  classes Class[]

  createdAt DateTime
  deletedAt DateTime?
}

model Class {
  id   String @id @unique @default(ulid())
  name String

  // Turno da turma (Matutino, Vespertino...)
  shift Shift

  // A turma atende quais séries? (Array permite turmas multisseriadas)
  grades SchoolGrade[]

  teacherId String
  teacher   Teacher @relation(fields: [teacherId], references: [id])

  lessons  Lesson[]
  students Student[]

  createdAt DateTime
  deletedAt DateTime?
}

model Lesson {
  id        String   @id @unique @default(ulid())
  date      DateTime // data_aula
  startTime String? // hora_inicio (ex: "13:00")
  endTime   String? // hora_final (ex: "14:00")
  duration  String? // duracao (ex: "1h")

  classId String
  class   Class  @relation(fields: [classId], references: [id])

  attendances Attendance[]

  createdAt DateTime
  deletedAt DateTime?
}

// ------------------------------------------------------
// ALUNO, RESPONSÁVEL E ENDEREÇO
// ------------------------------------------------------

model Student {
  id        String   @id @unique @default(ulid())
  name      String
  birthDate DateTime

  // Série atual do aluno (Enum fixo)
  currentGrade SchoolGrade

  classId String
  class   Class  @relation(fields: [classId], references: [id])

  addresses Address[]            @relation("StudentAddresses")
  guardians StudentHasGuardian[]

  enrollments Enrollment[]
  attendances Attendance[]

  createdAt DateTime
  deletedAt DateTime?
}

model Guardian {
  id    String  @id @unique @default(ulid())
  name  String
  email String? @unique
  phone String // Tel único

  addresses Address[]            @relation("GuardianAddresses")
  students  StudentHasGuardian[]

  createdAt DateTime
  deletedAt DateTime?
}

// Tabela associativa
model StudentHasGuardian {
  studentId  String
  guardianId String

  kinship Kinship @default(PAI_MAE)

  student  Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  guardian Guardian @relation(fields: [guardianId], references: [id], onDelete: Cascade)

  createdAt DateTime
  deletedAt DateTime?

  @@id([studentId, guardianId])
}

model Address {
  id         String  @id @unique @default(ulid())
  street     String
  number     String
  district   String
  complement String?
  city       String?
  state      String?

  students  Student[]  @relation("StudentAddresses")
  guardians Guardian[] @relation("GuardianAddresses")

  createdAt DateTime
  deletedAt DateTime?
}

// ------------------------------------------------------
// FINANCEIRO E ADMINISTRATIVO
// ------------------------------------------------------

model Contract {
  id            String    @id @unique @default(ulid())
  signatureDate DateTime
  dueDate       DateTime?
  documentUrl   String?

  enrollments Enrollment[]

  createdAt DateTime
  deletedAt DateTime?
}

model Enrollment {
  id             String   @id @unique @default(ulid())
  status         String // Ex: ATIVA, TRANCADA
  enrollmentDate DateTime

  studentId  String
  contractId String

  student  Student  @relation(fields: [studentId], references: [id])
  contract Contract @relation(fields: [contractId], references: [id])

  payments Payment[]

  createdAt DateTime
  deletedAt DateTime?
}

model Payment {
  id          String    @id @unique @default(ulid())
  amount      Float
  dueDate     DateTime // Data vencimento
  paymentDate DateTime? // Data pagamento
  status      String // PENDENTE, PAGO...

  enrollmentId String
  enrollment   Enrollment @relation(fields: [enrollmentId], references: [id])

  createdAt DateTime
  deletedAt DateTime?
}

// ------------------------------------------------------
// FREQUÊNCIA
// ------------------------------------------------------

model Attendance {
  id     String           @id @unique @default(ulid())
  status AttendanceStatus // PRESENTE, AUSENTE, JUSTIFICADO

  studentId String
  lessonId  String

  student Student @relation(fields: [studentId], references: [id])
  lesson  Lesson  @relation(fields: [lessonId], references: [id])

  createdAt DateTime
  deletedAt DateTime?

  // Chave composta para garantir unicidade
  @@unique([studentId, lessonId])
}
